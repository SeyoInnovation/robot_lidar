<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Seyo扫地机器人遥控器</title>
<script src="https://cdn.staticfile.org/roslibjs/1.1.0/roslib.min.js"></script>

<style>
body{
  font-family:sans-serif;
  text-align:center;
  background: linear-gradient(120deg,#a1c4fd,#c2e9fb,#fbc2eb,#a6c1ee);
}
.container{max-width:900px;margin:auto;}
.card{background:rgb(244, 251, 254);border-radius:16px;padding:18px;
    box-shadow:0 5px 20px rgba(0,0,0,.1);margin-top:20px;}
.active{background:#28a745 !important;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
button{height:80px;font-size:18px;border:none;border-radius:15px;background:#007bff;color:white;}
button:active{background:#0056c9;}
.stop{background:#dc3545;}
.small{height:40px;}
.status{margin-top:8px;color:#777;}
.map-wrap{overflow:auto;text-align:center;}
#mapCanvas{background:#ddd;border-radius:12px;}
.info{font-size:14px;color:#333;}
.value{font-weight:bold;}
.sliderBox{margin-top:10px;text-align:left}
.sliderBox label{font-size:14px;}
.sliderBox input{width:100%;}
.tool-row{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="container">

<h2>Seyo扫地机器人遥控器</h2>

<!-- 连接 -->
<div class="card">
  <label>机器人 IP: </label>
  <input id="ip" value="172.20.10.4">
  <button class="small" onclick="connect()">连接</button>
  <div id="status" class="status">未连接</div>
  <div></div>
    <button data-act="model1">模式1</button>
    <button data-act="model2">模式2</button>
    <div></div>
</div>

<!-- 速度实时反馈 -->
<div class="card">
  <div>线速度: <span id="linVel" class="value">0.00</span> m/s</div>
  <div>角速度: <span id="angVel" class="value">0.00</span> rad/s</div>
</div>

<!-- 自定义速度设置 -->
<div class="card">
  <h3>自定义速度</h3>

  <div class="sliderBox">
    <label>
      最大线速度 (m/s)：
      <span id="linSetVal" class="value">1.0</span>
    </label>
    <input id="linSet" type="range" min="0" max="2" step="0.05" value="1.0">
  </div>

  <div class="sliderBox">
    <label>
      最大角速度 (rad/s)：
      <span id="angSetVal" class="value">1.00</span>
    </label>
    <input id="angSet" type="range" min="0" max="3.0" step="0.05" value="1.0">
  </div>
</div>

<!-- 地图 -->
<div class="card map-wrap">
  <h3>地图</h3>
  <canvas id="mapCanvas" width="500" height="500"></canvas>
  <div class="info">来自 /map (OccupancyGrid)</div>
</div>

<!-- 控制 -->
<div class="card">
  <div class="grid">
    <div></div>
    <button data-act="forward">前进</button>
    <div></div>

    <button data-act="left">左转</button>
    <button class="stop" onclick="sendVel(0,0)">急停</button>
    <button data-act="right">右转</button>

    <div></div>
    <button data-act="backward">后退</button>
    <div></div>
  </div>
</div>

<div class="card">
  <div class="grid">
    <div class="tool-row">
      <button id="btn-water" data-act="water">喷水</button>
      <button id="btn-fan" data-act="fan">风机</button>
      <button id="btn-sweep" data-act="sweep">扫刷</button>

    </div>
  </div>
</div>

<script>
  /* ========== 模式按钮单独处理 ========= */
const m1=document.querySelector("button[data-act='model1']");
const m2=document.querySelector("button[data-act='model2']");
const waterBtn = document.getElementById("btn-water");
const fanBtn   = document.getElementById("btn-fan");
const sweepBtn = document.getElementById("btn-sweep");

let ros=null,cmdVel=null;
let odomSub=null,mapSub=null;
let holdTimer=null;
let modePub=null;
let currentMode = 0;
let funcPub = null;
let funcState = {water: 0,fan: 0,sweep: 0};

const ctx=document.getElementById("mapCanvas").getContext("2d");

/* ========== 连接 ========= */
function connect(){
  ros = new ROSLIB.Ros({
    url:'ws://'+document.getElementById("ip").value+':9090'
  });

  ros.on('connection',()=>{
    document.getElementById("status").innerText="已连接";
    setupPublish();
    setupOdom();
    setupMap();
    setupModePublisher();
    setupFunctionPublisher();
    setInterval(publishAll,100); // 每100ms发布一次模式和功能状态
  });

  ros.on('error',()=>document.getElementById("status").innerText="连接错误");
  ros.on('close',()=>document.getElementById("status").innerText="连接关闭");
}
/* ========== 功能话题 ========= */
function publishAll(){
  publishMode();
  publishFunction();
}

function setupFunctionPublisher(){
  funcPub = new ROSLIB.Topic({
    ros,
    name: '/function',
    messageType: 'std_msgs/msg/Int32MultiArray'
  });
}

function publishFunction(){
  if(!funcPub) return;

  funcPub.publish(new ROSLIB.Message({
    data: [
      funcState.water,
      funcState.fan,
      funcState.sweep
    ]
  }));

  console.log("功能状态：", funcState);
}

/* ========== 模式话题 ========= */
function setupModePublisher(){
  modePub = new ROSLIB.Topic({
    ros,
    name:'/mode_select',
    messageType:'std_msgs/msg/Int32MultiArray'
  });
}

function publishMode(){
  if(!modePub) return;

  let arr=[0,0];
  if(currentMode===1) arr=[1,0];
  if(currentMode===2) arr=[0,1];

  modePub.publish(new ROSLIB.Message({
    data:arr
  }));
}

/* ========== 发布 /cmd_vel ========= */
function setupPublish(){
  cmdVel=new ROSLIB.Topic({
    ros,
    name:'/cmd_vel',
    messageType:'geometry_msgs/msg/Twist'
  });
}

function sendVel(l,a){
  if(!cmdVel)return;
  cmdVel.publish(new ROSLIB.Message({
    linear:{x:l,y:0,z:0},
    angular:{x:0,y:0,z:a}
  }));
}

/* ========== 订阅 /odom ========= */
function setupOdom(){
  odomSub = new ROSLIB.Topic({
    ros,
    name:'/odom',
    messageType:'nav_msgs/msg/Odometry'
  });

  odomSub.subscribe(msg=>{
    document.getElementById("linVel").innerText =
      msg.twist.twist.linear.x.toFixed(2);
    document.getElementById("angVel").innerText =
      msg.twist.twist.angular.z.toFixed(2);
  });
}

/* ========== /map ========= */
function setupMap(){
  mapSub=new ROSLIB.Topic({
    ros,
    name:'/map',
    messageType:'nav_msgs/msg/OccupancyGrid'
  });

  mapSub.subscribe(msg=>drawMap(msg));
}

function drawMap(msg){
  const width = msg.info.width;
  const height = msg.info.height;
  const data = msg.data;

  const img = ctx.createImageData(width,height);

  for(let i=0;i<data.length;i++){
    let val=data[i];
    let color = (val===-1)?200:(val>50?0:255);
    img.data[i*4+0]=color;
    img.data[i*4+1]=color;
    img.data[i*4+2]=color;
    img.data[i*4+3]=255;
  }

  const canvas=document.getElementById("mapCanvas");

  const temp=document.createElement("canvas");
  temp.width=width;
  temp.height=height;
  temp.getContext("2d").putImageData(img,0,0);

  ctx.imageSmoothingEnabled=false;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(temp,0,0,width,height,0,0,canvas.width,canvas.height);
}

/* ========== 自定义速度 ========== */
const linSlider=document.getElementById("linSet");
const angSlider=document.getElementById("angSet");

let maxLinear=parseFloat(linSlider.value);
let maxAngular=parseFloat(angSlider.value);

linSlider.oninput=()=>{
  maxLinear=parseFloat(linSlider.value);
  document.getElementById("linSetVal").innerText=maxLinear.toFixed(2);
};

angSlider.oninput=()=>{
  maxAngular=parseFloat(angSlider.value);
  document.getElementById("angSetVal").innerText=maxAngular.toFixed(2);
};

/* ========== 运动控制（长按） ========== */
function startAction(type){
  let lv=0,av=0;

  if(type==="forward")  lv=maxLinear;
  if(type==="backward") lv=-maxLinear;
  if(type==="left")     av=maxAngular;
  if(type==="right")    av=-maxAngular;

  sendVel(lv,av);
  holdTimer=setInterval(()=>sendVel(lv,av),100);
}

function stopAction(){
  clearInterval(holdTimer);
  sendVel(0,0);
}
function updateUI(){
  // --- 模式按钮 ---
  m1.classList.toggle("active", currentMode === 1);
  m2.classList.toggle("active", currentMode === 2);

  // --- 功能按钮 ---
  waterBtn.classList.toggle("active", funcState.water === 1);
  fanBtn.classList.toggle("active",   funcState.fan   === 1);
  sweepBtn.classList.toggle("active", funcState.sweep === 1);
}
/* ========== 绑定运动按钮 ========= */
document.querySelectorAll("button[data-act='forward'],button[data-act='backward'],button[data-act='left'],button[data-act='right']").forEach(btn=>{
  btn.addEventListener("mousedown",()=>startAction(btn.dataset.act));
  btn.addEventListener("touchstart",()=>startAction(btn.dataset.act),{passive:true});
});

document.getElementById("btn-water").onclick = ()=>{
  funcState.water ^= 1;
  updateUI();
};

document.getElementById("btn-fan").onclick = ()=>{
  funcState.fan ^= 1;
  updateUI();
};

document.getElementById("btn-sweep").onclick = ()=>{
  funcState.sweep ^= 1;
  updateUI();
};
m1.addEventListener("click",()=>{
  currentMode = 1;
  publishMode();
});

m2.addEventListener("click",()=>{
  currentMode = 2;
  publishMode();
});


window.addEventListener("mouseup",stopAction);
window.addEventListener("touchend",stopAction);
window.addEventListener("touchcancel",stopAction);




</script>

</body>
</html>
